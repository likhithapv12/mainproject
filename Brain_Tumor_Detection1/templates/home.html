{% extends "base.html" %}

{% block title %}Home - Brain Tumor Detection{% endblock %}

{% block content %}
<div class="text-center mb-4">
    <h2>Welcome, {{ session.full_name }}!</h2>
    <p class="text-muted">Upload retinal images for advanced brain tumor detection analysis</p>
</div>

<!-- Upload Alert Area -->
<div id="uploadMessageArea" style="display: none;">
    <!-- Messages will appear here -->
</div>

<!-- Upload Section -->
<div class="feature-card">
    <div class="upload-area" id="uploadArea">
        <div class="upload-icon">
            <i class="fas fa-cloud-upload-alt"></i>
        </div>
        <h3>Upload Retinal Image</h3>
        <p>Click here or drag and drop your retinal image for analysis</p>
        <p><small class="text-muted">Supported formats: JPG, PNG, BMP | Max size: 16MB</small></p>
        <input type="file" id="imageInput" accept="image/*" style="display: none;">
    </div>

    <div id="imagePreview" class="text-center" style="display: none;">
        <h4><i class="fas fa-check-circle text-success"></i> Image Uploaded Successfully</h4>
        <div id="previewContainer"></div>
        <div class="mt-3">
            <a href="{{ url_for('analysis') }}" class="btn btn-success" id="proceedBtn">
                <i class="fas fa-microscope"></i> Proceed to Analysis
            </a>
            <button class="btn btn-secondary" onclick="resetUpload()">
                <i class="fas fa-redo"></i> Upload Different Image
            </button>
        </div>
    </div>
</div>

<!-- Features Grid -->
<div class="row mt-4">
    <div class="col-lg-6 mb-3">
        <div class="feature-card">
            <h4><i class="fas fa-bullseye text-primary"></i> Accurate Detection</h4>
            <p>Advanced CNN model trained on thousands of retinal images for precise tumor detection with 95%+ accuracy.</p>
        </div>
    </div>
    <div class="col-lg-6 mb-3">
        <div class="feature-card">
            <h4><i class="fas fa-bolt text-warning"></i> Fast Processing</h4>
            <p>Real-time image preprocessing and analysis using OpenCV and deep learning algorithms.</p>
        </div>
    </div>
    <div class="col-lg-6 mb-3">
        <div class="feature-card">
            <h4><i class="fas fa-chart-line text-info"></i> Detailed Reports</h4>
            <p>Comprehensive analysis with papilledema detection, RNFL analysis, and confidence scores.</p>
        </div>
    </div>
    <div class="col-lg-6 mb-3">
        <div class="feature-card">
            <h4><i class="fas fa-shield-alt text-success"></i> Secure Storage</h4>
            <p>Patient data and results securely stored with complete privacy protection and HIPAA compliance.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const uploadArea = document.getElementById('uploadArea');
const imageInput = document.getElementById('imageInput');
const imagePreview = document.getElementById('imagePreview');
const previewContainer = document.getElementById('previewContainer');
const messageArea = document.getElementById('uploadMessageArea');

// Helper function to show styled error messages
function showMessage(type, message) {
    messageArea.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Upload Failed:</strong> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
    messageArea.style.display = 'block';
}

function hideMessage() {
    messageArea.style.display = 'none';
}


// Click to upload
uploadArea.addEventListener('click', () => {
    imageInput.click();
    hideMessage(); // Clear previous messages on new attempt
});

// File input change
imageInput.addEventListener('change', handleFileUpload);

// Drag and drop
uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    hideMessage();
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFile(files[0]);
    }
});

function handleFileUpload(event) {
    const file = event.target.files[0];
    if (file) {
        handleFile(file);
    }
}

function handleFile(file) {
    // Client-side validation
    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/bmp'];
    if (!allowedTypes.includes(file.type)) {
        showMessage('danger', 'Please upload a valid image file (JPG, PNG, BMP).');
        return;
    }
    
    if (file.size > 16 * 1024 * 1024) {
        showMessage('danger', 'File size too large. Please select an image under 16MB.');
        return;
    }
    
    // Upload file to server
    const formData = new FormData();
    formData.append('image', file);
    
    // Show loading
    uploadArea.innerHTML = `
        <div class="upload-icon">
            <i class="fas fa-spinner fa-spin"></i>
        </div>
        <h3>Uploading Image...</h3>
        <p>Please wait while we process your image</p>
    `;
    
    fetch('/upload_image', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        // If server returns an error status (e.g., 400), handle it here
        if (!response.ok) {
            return response.json().then(data => {
                // If validation failed, the server sends back the error message
                throw new Error(data.error || `HTTP error! status: ${response.status}`);
            });
        }
        return response.json();
    })
    .then(data => {
        console.log('Upload response:', data);
        if (data.success) {
            displayImagePreview(file);
        } else {
            // Fallback for non-400 server errors
            showMessage('danger', data.error || 'Unknown upload error.');
            resetUpload();
        }
    })
    .catch(error => {
        console.error('Upload error:', error);
        // Display the specific error message from the server validation
        showMessage('danger', error.message.replace('Error: ', '')); 
        resetUpload();
    });
}

function displayImagePreview(file) {
    hideMessage();
    const reader = new FileReader();
    reader.onload = function(e) {
        previewContainer.innerHTML = `
            <p><strong>File:</strong> ${file.name}</p>
            <p><strong>Size:</strong> ${(file.size / (1024 * 1024)).toFixed(2)} MB</p>
            <img src="${e.target.result}" alt="Retinal Image" class="image-preview">
        `;
        
        uploadArea.style.display = 'none';
        imagePreview.style.display = 'block';
    };
    reader.readAsDataURL(file);
}

function resetUpload() {
    uploadArea.style.display = 'block';
    uploadArea.innerHTML = `
        <div class="upload-icon">
            <i class="fas fa-cloud-upload-alt"></i>
        </div>
        <h3>Upload Retinal Image</h3>
        <p>Click here or drag and drop your retinal image for analysis</p>
        <p><small class="text-muted">Supported formats: JPG, PNG, BMP | Max size: 16MB</small></p>
    `;
    imagePreview.style.display = 'none';
    imageInput.value = '';
}
</script>
{% endblock %}
